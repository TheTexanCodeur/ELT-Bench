query_plan_spider:
  instruction: |
    Your task is to focus ONLY on creating the transformation query plan: analyze the data model requirements and source schemas to create a comprehensive query plan that will guide subsequent SQL development. Create a detailed .txt file outlining how source tables should be transformed into the final data models defined in data_model.yaml. Do NOT write actual SQL queries - focus on the high-level transformation logic, data flow, and dependencies.
  max_steps: 15

sql_spider:
  instruction: |
    Your task is to generate the SQL queries based on the provided query plan. Carefully read the query_plan.txt file created by the previous agent, and translate each step of the plan into executable SQL statements that will transform the source data into the desired data models as specified in data_model.yaml. Ensure that the SQL queries are efficient, accurate, and adhere to best practices for database operations.
  max_steps: 15

dbt_spider:
  instruction: |
    Your task is to create the DBT configuration files (dbt_project.yml and profiles.yml)
    required to run the SQL models generated by the SQL Spider.

    You MUST:
    - Read config.yaml for Snowflake connection and SCHEMA settings.
    - Read all SQL models in ./sql/.
    - Use exactly the schema from config.yaml (uppercase).
    - Never invent a schema.
    - Never modify SQL.
    - Never create extra files.
    - Produce valid DBT YAML only.

    Follow the system prompt rules strictly.
  max_steps: 15

correction_plan_spider:
  instruction: |
    Your task is to create or update exactly one file: correction_plan.txt.
    You must analyze dbt run logs in ./logs/dbt.log, SQL models in ./sql/, and
    dbt configuration files, then identify the root cause of the failure.

    You must write a deterministic, step-by-step correction plan:
    - NO SQL execution
    - NO speculative fixes
    - EXACT file paths
    - EXACT line ranges or anchor text
    - EXACT replace/insert/delete operations
    - MINIMAL changes only
    - Never create new schemas, tables, directories, or filenames

    Follow the system prompt rules strictly.

  max_steps: 10

correction_spider:
  instruction: |
    Your task is to APPLY the corrections described in correction_plan.txt. 
    Do not analyze the errors yourself and do not invent new fixes. 
    Read correction_plan.txt completely using Bash, then update only the files 
    explicitly referenced in the plan. Apply each fix exactly as written, using the 
    specified file paths, line anchors, and replace/insert/delete instructions.

    You MUST:
    - Modify only the files listed in the correction plan.
    - Perform only the actions described in the plan.
    - Use EditFile for all modifications.
    - Make minimal, surgical edits exactly matching the planâ€™s content.
    - Never rewrite entire files unless the plan explicitly requires it.
    - Never change any SQL or YAML that is not part of the plan.
    - Never create new files, rename files, or invent schemas or fields.

    Follow the system prompt strictly.
  max_steps: 15


verification_spider:
  instruction: |
    Your task is to perform semantic verification of the dbt-generated models.

    You MUST:
    - Read config.yaml to identify the correct database and schema.
    - Discover model names by listing the ./sql/ directory.
    - For EACH model, sample rows directly from Snowflake using SF_SAMPLE_ROWS
    - Read these sample files using Bash to analyze the values.

    You MUST check for:
    - Schema consistency with data_model.yaml
    - Structural correctness (row uniqueness, fanout, missing rows)
    - Logical correctness (flags, ratios, aggregations)
    - Value-level consistency (null handling, numeric sanity)
    - Cross-model alignment when applicable

    You MUST produce exactly one file: verification_report.txt
    If the file already exists, use EditFile to update it. Do NOT use Bash to delete it.

    The report MUST NOT propose fixes.
    It MUST only describe observed issues with evidence from samples.

    Follow the system prompt rules strictly.
  max_steps: 25


semantic_correction_plan_spider:
  instruction: |
      Your task is to create semantic correction plan 
      based on the verification_report.txt.
      You MUST write a deterministic, step-by-step correction plan:
      - NO SQL execution
      - NO speculative fixes
      - EXACT file paths
      - EXACT line ranges or anchor text
      - EXACT replace/insert/delete operations
      - MINIMAL changes only
      - Never create new schemas, tables, directories, or filenames
      Follow the system prompt rules strictly.

  max_steps: 15